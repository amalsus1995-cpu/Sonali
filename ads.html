<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</title>
<style>
body { background:#111; color:white; font-family:sans-serif; text-align:center; }
.ad-box { background:#222; margin:10px; padding:15px; border-radius:10px; }
.menu a { color:white; text-decoration:none; display:block; margin:10px; font-size:20px; }
button {
  background:#0f0;
  padding:10px 15px;
  border:none;
  border-radius:8px;
  font-size:18px;
  cursor:pointer;
}
button:disabled {
  background:#555;
  cursor:not-allowed;
}
</style>
</head>

<body>

<h2>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>

<div id="ads-list"></div>

<div class="menu">
<a href="profile.html">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù</a>
<a href="wallet.html">ğŸ’¼ Ù…Ø­ÙØ¸ØªÙŠ</a>
<a href="about.html">â„¹ï¸ Ù…Ù† Ù†Ø­Ù†</a>
<a href="index.html">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<script src="supabase.js"></script>

<script>
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù† Supabase
async function loadAds() {
  let { data, error } = await supabase.from("ads2").select("*");

  if (!data) return;

  const container = document.getElementById("ads-list");
  container.innerHTML = "";

  data.forEach(ad => {
    container.innerHTML += `
      <div class="ad-box">
        <p>Ø¥Ø¹Ù„Ø§Ù† Ø±Ù‚Ù…: ${ad.id}</p>
        <video width="300" controls src="${ad.video_url}"></video>
        <br><br>
        <button onclick="watchAd(${ad.id})" id="btn-${ad.id}">ğŸ¬ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
      </div>
    `;
  });
}

// ÙƒÙˆØ¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
async function watchAd(adId) {
  const { data: session } = await supabase.auth.getSession();

  if (!session || !session.session) {
    alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const uid = session.session.user.id;

  // 1ï¸âƒ£ Ø§Ù„ØªØ£ÙƒØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø³Ø§Ø¨Ù‚Ø§Ù‹
  let { data: viewed } = await supabase
    .from("views_log")
    .select("*")
    .eq("user_id", uid)
    .eq("ad_id", adId)
    .maybeSingle();

  if (viewed) {
    alert("Ù„Ù‚Ø¯ Ø´Ø§Ù‡Ø¯Øª Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
    document.getElementById("btn-" + adId).disabled = true;
    return;
  }

  // 2ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
  let { error: logError } = await supabase
    .from("views_log")
    .insert([{ user_id: uid, ad_id: adId }]);

  if (logError) {
    alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©");
    return;
  }

  // 3ï¸âƒ£ Ø¥Ø¶Ø§ÙØ© 3 Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  let { error: pointsError } = await supabase.rpc("add_points", {
    uid: uid,
    points: 3
  });

  if (pointsError) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·");
    return;
  }

  alert("ØªÙ…Øª Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† + Ø¥Ø¶Ø§ÙØ© 3 Ù†Ù‚Ø§Ø· âœ”");

  // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
  document.getElementById("btn-" + adId).disabled = true;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadAds();
</script>

</body>
</html>
