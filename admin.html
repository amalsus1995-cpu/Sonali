<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - my-ads-app</title>

<style>
:root {
  --gold: #ffd700;
  --gold-dark: #d4af37;
  --silver: #c0c0c0;
  --bg-dark: #111827;
  --bg-darker: #020617;
  --card-bg: rgba(15,23,42,0.95);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #333, #000);
  color: #e5e7eb;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header {
  padding: 18px 16px;
  background: linear-gradient(90deg, var(--gold-dark), var(--silver));
  color: #111;
  box-shadow: 0 4px 18px rgba(0,0,0,0.6);
  position: sticky;
  top: 0;
  z-index: 10;
}
.header h1 {
  margin: 0;
  font-size: 22px;
}
.header p {
  margin: 4px 0 0;
  font-size: 13px;
}

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.container {
  max-width: 1100px;
  margin: 16px auto 40px;
  padding: 0 12px;
}

/* Ø¨ÙˆÙƒØ³ Ø¹Ø§Ù… */
.card {
  background: var(--card-bg);
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.7);
  border: 1px solid rgba(148,163,184,0.4);
}

/* Ø´Ø§Ø´Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† */
#admin-login {
  max-width: 420px;
  margin: 40px auto;
  text-align: center;
  background: linear-gradient(145deg, rgba(17,24,39,0.9), rgba(15,23,42,0.95));
}
#admin-login h2 {
  margin-top: 0;
  margin-bottom: 10px;
  color: var(--gold);
}
input, select, button, textarea {
  font-family: inherit;
}

/* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
.input {
  width: 100%;
  padding: 10px 11px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid #4b5563;
  background: #020617;
  color: #e5e7eb;
}

/* Ø²Ø± Ø°Ù‡Ø¨ÙŠ */
.btn {
  margin-top: 12px;
  width: 100%;
  padding: 11px;
  border-radius: 999px;
  border: none;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  background: linear-gradient(90deg, var(--gold), var(--gold-dark));
  color: #111827;
  box-shadow: 0 6px 16px rgba(0,0,0,0.5);
}
.btn:active {
  transform: translateY(1px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.4);
}

/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
.section-title {
  font-size: 16px;
  margin: 0 0 8px;
  color: var(--gold);
}

/* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
}
.stat-card {
  background: rgba(15,23,42,0.95);
  border-radius: 12px;
  padding: 12px;
  border: 1px solid rgba(148,163,184,0.5);
}
.stat-label {
  font-size: 12px;
  color: #9ca3af;
}
.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--gold);
}

/* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
.table-wrapper {
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th, td {
  padding: 8px 6px;
  border-bottom: 1px solid rgba(55,65,81,0.9);
}
th {
  text-align: right;
  background: rgba(31,41,55,0.9);
  color: #e5e7eb;
  position: sticky;
  top: 0;
  z-index: 1;
}
tr:nth-child(even) td {
  background: rgba(15,23,42,0.6);
}

/* Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
}
.badge-pending { background: #f59e0b; color: #111; }
.badge-accepted { background: #22c55e; color: #052e16; }
.badge-rejected { background: #ef4444; color: #fee2e2; }

.btn-xs {
  padding: 4px 7px;
  border-radius: 999px;
  border: none;
  font-size: 11px;
  cursor: pointer;
  margin: 1px;
}
.btn-green { background:#22c55e; color:#052e16; }
.btn-red { background:#ef4444; color:#fee2e2; }
.btn-orange { background:#f97316; color:#111827; }

/* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
.grid-2 {
  display: grid;
  grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
  gap: 12px;
}
@media(max-width: 800px) {
  .grid-2 {
    grid-template-columns: minmax(0, 1fr);
  }
}
</style>
</head>

<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
<div class="header">
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” my-ads-app ğŸ‘‘</h1>
  <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§ØªØŒ ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Ø³ØªØ§ÙŠÙ„ Ø°Ù‡Ø¨ÙŠ + ÙØ¶ÙŠ)</p>
</div>

<div class="container">

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† -->
  <div id="admin-login" class="card">
    <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
    <p style="font-size:13px;color:#d1d5db;">
      Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
    </p>
    <input id="admin-pass" class="input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù†">
    <button class="btn" onclick="checkAdmin()">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„Ø© -->
  <div id="admin-panel" style="display:none;">

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© -->
    <div class="card">
      <h3 class="section-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
          <div id="stat-users" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
          <div id="stat-ads" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</div>
          <div id="stat-withdraw" class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</div>
          <div id="stat-paid" class="stat-value">$0</div>
        </div>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø¥Ø¹Ù„Ø§Ù†Ø§Øª + Ø³Ø­ÙˆØ¨Ø§Øª -->
    <div class="grid-2">

      <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª -->
      <div class="card">
        <h3 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ğŸ¥</h3>
        <input id="ad-link" class="input" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨ (shorts Ø£Ùˆ watch)">
        <button class="btn" onclick="addAd()">Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</button>
        <div style="margin-top:10px;" class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</th>
                <th>Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="ads-body">
              <tr><td colspan="3">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª -->
      <div class="card">
        <h3 class="section-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ ğŸ’¸</h3>
        <div class="table-wrapper" style="max-height:320px;">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="withdraw-body">
              <tr><td colspan="4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div class="card">
      <h3 class="section-title">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ğŸ‘¥</h3>
      <p style="font-size:12px;color:#9ca3af;margin-top:0;">
        ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø£Ùˆ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.
      </p>
      <div class="table-wrapper" style="max-height:360px;">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
              <th>Ø§Ù„Ø±ØµÙŠØ¯ ($)</th>
              <th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
              <th>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="users-body">
            <tr><td colspan="5">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- /admin-panel -->

</div><!-- /container -->

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="supabase.js"></script>

<script>
// ğŸ›¡ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù† (ØºÙŠØ±Ù‡Ø§ Ø¨Ø±Ø§Ø­ØªÙƒ)
const ADMIN_PASSWORD = "admin12345";

// ØªÙØ¹ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
function checkAdmin() {
  const pass = document.getElementById("admin-pass").value.trim();
  if (pass === ADMIN_PASSWORD) {
    document.getElementById("admin-login").style.display = "none";
    document.getElementById("admin-panel").style.display = "block";
    loadAll();
  } else {
    alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
  }
}

// ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function loadAll() {
  loadStats();
  loadAds();
  loadUsers();
  loadWithdraws();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
async function loadStats() {
  // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  const { count: usersCount } = await supabase
    .from("users")
    .select("*", { count: "exact", head: true });

  // Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
  const { count: adsCount } = await supabase
    .from("ads")
    .select("*", { count: "exact", head: true });

  // Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
  const { data: withdraws } = await supabase
    .from("withdraw")
    .select("*");

  const totalWithdraw = withdraws ? withdraws.length : 0;
  let totalPaid = 0;
  if (withdraws) {
    withdraws.forEach(w => {
      if (w.status === "accepted") {
        totalPaid += Number(w.amount || 0);
      }
    });
  }

  document.getElementById("stat-users").innerText = usersCount || 0;
  document.getElementById("stat-ads").innerText = adsCount || 0;
  document.getElementById("stat-withdraw").innerText = totalWithdraw;
  document.getElementById("stat-paid").innerText = "$" + totalPaid;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
async function loadAds() {
  const tbody = document.getElementById("ads-body");
  tbody.innerHTML = "<tr><td colspan='3'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";

  const { data, error } = await supabase.from("ads").select("*").order("id", { ascending: false });
  if (error) {
    tbody.innerHTML = "<tr><td colspan='3'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</td></tr>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='3'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¶Ø§ÙØ©</td></tr>";
    return;
  }

  tbody.innerHTML = "";
  data.forEach(ad => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ad.id}</td>
      <td style="max-width:260px;word-break:break-all;">${ad.youtube_url}</td>
      <td><button class="btn-xs btn-red" onclick="deleteAd(${ad.id})">Ø­Ø°Ù</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
async function addAd() {
  const input = document.getElementById("ad-link");
  const link = input.value.trim();
  if (!link) {
    alert("Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }

  const { error } = await supabase.from("ads").insert([{ youtube_url: link, reward: 3 }]);
  if (error) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.");
    console.error(error);
    return;
  }

  alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­.");
  input.value = "";
  loadAds();
  loadStats();
}

// Ø­Ø°Ù Ø¥Ø¹Ù„Ø§Ù†
async function deleteAd(id) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) return;
  await supabase.from("ads").delete().eq("id", id);
  loadAds();
  loadStats();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUsers() {
  const tbody = document.getElementById("users-body");
  tbody.innerHTML = "<tr><td colspan='5'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";

  const { data, error } = await supabase
    .from("users")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    tbody.innerHTML = "<tr><td colspan='5'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</td></tr>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='5'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯</td></tr>";
    return;
  }

  tbody.innerHTML = "";
  data.forEach(user => {
    const tr = document.createElement("tr");
    const email = user.email || user.auth_user_id || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    const points = user.points || 0;
    const wallet = user.wallet_address || "â€”";

    tr.innerHTML = `
      <td style="max-width:200px;word-break:break-all;">${email}</td>
      <td>${points}</td>
      <td style="max-width:220px;word-break:break-all;">${wallet}</td>
      <td>
        <button class="btn-xs btn-green" onclick="changePoints('${user.id}', 10)">+10</button>
        <button class="btn-xs btn-green" onclick="changePoints('${user.id}', 50)">+50</button>
        <button class="btn-xs btn-green" onclick="changePoints('${user.id}', 100)">+100</button>
        <button class="btn-xs btn-red" onclick="changePoints('${user.id}', -10)">-10</button>
      </td>
      <td>
        <button class="btn-xs btn-orange" onclick="deleteUser('${user.id}')">Ø­Ø°Ù</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø²ÙŠØ§Ø¯Ø© Ø£Ùˆ Ù†Ù‚ØµØ§Ù†)
async function changePoints(userId, diff) {
  // Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const { data, error } = await supabase
    .from("users")
    .select("points")
    .eq("id", userId)
    .single();

  if (error) {
    alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
    console.error(error);
    return;
  }

  const current = data?.points || 0;
  let next = current + diff;
  if (next < 0) next = 0;

  const { error: upErr } = await supabase
    .from("users")
    .update({ points: next })
    .eq("id", userId);

  if (upErr) {
    alert("Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯");
    console.error(upErr);
    return;
  }

  loadUsers();
  loadStats();
}

// Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…
async function deleteUser(userId) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŸ")) return;
  await supabase.from("users").delete().eq("id", userId);
  loadUsers();
  loadStats();
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
async function loadWithdraws() {
  const tbody = document.getElementById("withdraw-body");
  tbody.innerHTML = "<tr><td colspan='4'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";

  const { data, error } = await supabase
    .from("withdraw")
    .select("*")
    .order("id", { ascending: false });

  if (error) {
    tbody.innerHTML = "<tr><td colspan='4'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</td></tr>";
    console.error(error);
    return;
  }

  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='4'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</td></tr>";
    return;
  }

  tbody.innerHTML = "";
  data.forEach(w => {
    const tr = document.createElement("tr");
    const badgeClass =
      w.status === "accepted" ? "badge-accepted" :
      w.status === "rejected" ? "badge-rejected" :
      "badge-pending";

    tr.innerHTML = `
      <td>${w.user_id}</td>
      <td>${w.amount}$</td>
      <td><span class="badge ${badgeClass}">${w.status}</span></td>
      <td>
        <button class="btn-xs btn-green" onclick="setWithdrawStatus(${w.id}, 'accepted', ${w.amount})">Ù‚Ø¨ÙˆÙ„</button>
        <button class="btn-xs btn-red" onclick="setWithdrawStatus(${w.id}, 'rejected', ${w.amount})">Ø±ÙØ¶</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Ù‚Ø¨ÙˆÙ„ / Ø±ÙØ¶ Ø§Ù„Ø³Ø­Ø¨
async function setWithdrawStatus(withdrawId, status, amount) {
  // Ù†Ø­Ø¯Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨
  await supabase
    .from("withdraw")
    .update({ status })
    .eq("id", withdrawId);

  // Ù„Ùˆ Ù‚Ø¨Ù„Ù†Ø§ Ø§Ù„Ø³Ø­Ø¨ØŒ Ù†Ù†Ù‚Øµ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  if (status === "accepted") {
    const { data: w } = await supabase
      .from("withdraw")
      .select("user_id")
      .eq("id", withdrawId)
      .single();

    if (w && w.user_id) {
      const { data: user } = await supabase
        .from("users")
        .select("points")
        .eq("id", w.user_id)
        .single();

      if (user) {
        let newPoints = (user.points || 0) - Number(amount || 0);
        if (newPoints < 0) newPoints = 0;

        await supabase
          .from("users")
          .update({ points: newPoints })
          .eq("id", w.user_id);
      }
    }
  }

  loadWithdraws();
  loadUsers();
  loadStats();
}
</script>

</body>
</html>
